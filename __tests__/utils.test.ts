import { describe, expect, test } from "@jest/globals";
import { json_hash, parse_latest_version } from "../src/utils";

describe("utils module", () => {
    test("hash from profile json is deterministic", async () => {
        const profile_a = `{"host": {"settings": {"arch": "x86_64", "compiler": "gcc"}}, "build": {"settings": {"compiler": "gcc"}}}`;
        const profile_b = `{"build": {"settings": {"compiler": "gcc"}}, "host": {"settings": {"compiler": "gcc", "arch": "x86_64"}}}`;

        const h_a = json_hash(profile_a);
        const h_b = json_hash(profile_b);

        expect(h_a.length).toBeGreaterThan(0);
        expect(h_a).toEqual(h_b);
    });

    test("latest version from pip index", () => {
        const output = `conan (2.18.1)
Available versions: 2.18.1, 2.18.0, 2.17.1, 2.17.0, 2.16.1, 2.16.0, 2.15.1, 2.15.0, 2.14.0, 2.13.0, 2.12.2, 2.12.1, 2.12.0, 2.11.0, 2.10.3, 2.10.2, 2.10.1, 2.10.0, 2.9.3, 2.9.2, 2.9.1, 2.9.0, 2.8.1, 2.8.0, 2.7.1, 2.7.0, 2.6.0, 2.5.0, 2.4.1, 2.4.0, 2.3.2, 2.3.1, 2.3.0, 2.2.3, 2.2.2, 2.2.1, 2.2.0, 2.1.0, 2.0.17, 2.0.16, 2.0.15, 2.0.14, 2.0.13, 2.0.12, 2.0.11, 2.0.10, 2.0.9, 2.0.8, 2.0.7, 2.0.6, 2.0.5, 2.0.4, 2.0.3, 2.0.2, 2.0.1, 2.0.0, 1.66.0, 1.65.0, 1.64.1, 1.64.0, 1.63.0, 1.62.0, 1.61.0, 1.60.2, 1.60.1, 1.60.0, 1.59.0, 1.58.0, 1.57.0, 1.56.0, 1.55.0, 1.54.0, 1.53.0, 1.52.0, 1.51.3, 1.51.2, 1.51.1, 1.51.0, 1.50.2, 1.50.1, 1.50.0, 1.49.0, 1.48.2, 1.48.1, 1.48.0, 1.47.0, 1.46.2, 1.46.1, 1.46.0, 1.45.0, 1.44.1, 1.44.0, 1.43.4, 1.43.3, 1.43.2, 1.43.1, 1.43.0, 1.42.2, 1.42.1, 1.42.0, 1.41.0, 1.40.4, 1.40.3, 1.40.2, 1.40.1, 1.40.0, 1.39.0, 1.38.0, 1.37.2, 1.37.1, 1.37.0, 1.36.0, 1.35.2, 1.35.1, 1.35.0, 1.34.1, 1.34.0, 1.33.1, 1.33.0, 1.32.1, 1.32.0, 1.31.4, 1.31.3, 1.31.2, 1.31.1, 1.31.0, 1.30.2, 1.30.1, 1.30.0, 1.29.2, 1.29.1, 1.29.0, 1.28.2, 1.28.1, 1.28.0, 1.27.1, 1.27.0, 1.26.1, 1.26.0, 1.25.2, 1.25.1, 1.25.0, 1.24.1, 1.24.0, 1.23.0, 1.22.3, 1.22.2, 1.22.1, 1.22.0, 1.21.3, 1.21.2, 1.21.1, 1.21.0, 1.20.5, 1.20.4, 1.20.3, 1.20.2, 1.20.1, 1.20.0, 1.19.4, 1.19.3, 1.19.2, 1.19.1, 1.19.0, 1.18.6, 1.18.5, 1.18.4, 1.18.3, 1.18.2, 1.18.1, 1.18.0, 1.17.3, 1.17.2, 1.17.1, 1.17.0, 1.16.2, 1.16.1, 1.16.0, 1.15.5, 1.15.4, 1.15.3, 1.15.2, 1.15.1, 1.15.0, 1.14.6, 1.14.5, 1.14.4, 1.14.3, 1.14.2, 1.14.1, 1.14.0, 1.13.4, 1.13.3, 1.13.2, 1.13.1, 1.13.0, 1.12.4, 1.12.3, 1.12.2, 1.12.1, 1.12.0, 1.11.3, 1.11.2, 1.11.1, 1.11.0, 1.10.3, 1.10.2, 1.10.1, 1.10.0, 1.9.3, 1.9.2, 1.9.1, 1.9.0, 1.8.5, 1.8.4, 1.8.3, 1.8.2, 1.8.1, 1.8.0, 1.7.6, 1.7.5, 1.7.4, 1.7.3, 1.7.2, 1.7.1, 1.7.0, 1.6.1, 1.6.0, 1.5.2, 1.5.1, 1.5.0, 1.4.5, 1.4.4, 1.4.3, 1.4.2, 1.4.1, 1.4.0, 1.3.3, 1.3.2, 1.3.1, 1.3.0, 1.2.3, 1.2.2, 1.2.1, 1.2.0, 1.1.1, 1.1.0, 1.0.4, 1.0.3, 1.0.2, 1.0.1, 1.0.0, 0.30.3, 0.30.2, 0.30.1, 0.29.2, 0.29.1, 0.29.0, 0.28.1, 0.28.0, 0.27.0, 0.26.2, 0.26.1, 0.26.0, 0.25.1, 0.25.0, 0.24.0, 0.23.2, 0.23.1, 0.23.0, 0.22.3, 0.22.2, 0.22.1, 0.22.0, 0.21.2, 0.21.1, 0.21.0, 0.20.3, 0.20.2, 0.20.1, 0.20.0, 0.19.3, 0.18.1, 0.17.2, 0.16.1, 0.15.0
  INSTALLED: 2.18.1
  LATEST:    2.18.1
`;
        const latest = parse_latest_version(output);
        expect(latest).toBeDefined();
        expect(latest).not.toEqual("");
        if (latest) {
            expect(latest.toString()).toEqual("2.18.1");
        }
    });
});
